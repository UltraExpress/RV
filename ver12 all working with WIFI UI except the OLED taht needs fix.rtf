{\rtf1\ansi\ansicpg1252\cocoartf2818
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fnil\fcharset0 Menlo-Regular;}
{\colortbl;\red255\green255\blue255;\red131\green148\blue149;\red255\green255\blue255;\red61\green73\blue78;
\red96\green126\blue3;\red9\green74\blue76;\red199\green63\blue5;\red17\green134\blue139;\red52\green62\blue66;
}
{\*\expandedcolortbl;;\cssrgb\c58431\c64706\c65098;\cssrgb\c100000\c100000\c100000;\cssrgb\c30588\c35686\c38039;
\cssrgb\c44706\c55686\c0;\cssrgb\c0\c36078\c37255;\cssrgb\c82745\c32941\c0;\cssrgb\c0\c59216\c61569;\cssrgb\c26275\c30980\c32941;
}
\margl1440\margr1440\vieww11520\viewh8400\viewkind0
\deftab720
\pard\pardeftab720\partightenfactor0

\f0\fs24 \cf2 \cb3 \expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 /* Combined RV Thermostat Control System\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2  * VERSION 12.2\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2  * Features:\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2  * - Temperature + humidity (BME280)\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2  * - WiFi setup (AP mode if no creds)\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2  * - Web interface with:\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2  *    * Freeze Guard overlay (touch-hold to enable/disable at 38deg)\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2  *    * Real-time data endpoint (/data)\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2  *    * Brightness control with dimming\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2  *    * Advanced styling + animations\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2  * - OLED display (Adafruit SSD1306)\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2  * - Heater control with target + freeze guard hysteresis\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2  */\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 // Libraries\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #include\cf4 \strokec4  \cf6 \strokec6 <Wire.h>\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #include\cf4 \strokec4  \cf6 \strokec6 <Adafruit_GFX.h>\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #include\cf4 \strokec4  \cf6 \strokec6 <Adafruit_SSD1306.h>\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #include\cf4 \strokec4  \cf6 \strokec6 <Adafruit_BME280.h>\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #include\cf4 \strokec4  \cf6 \strokec6 <WiFi.h>\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #include\cf4 \strokec4  \cf6 \strokec6 <WebServer.h>\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #include\cf4 \strokec4  \cf6 \strokec6 <EEPROM.h>\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 // Definitions\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 SCREEN_WIDTH\cf4 \strokec4  \cf6 \strokec6 128\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 SCREEN_HEIGHT\cf4 \strokec4  \cf6 \strokec6 64\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 OLED_RESET\cf4 \strokec4  -\cf6 \strokec6 1\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 SCREEN_ADDRESS\cf4 \strokec4  0x\cf6 \strokec6 3C\cf4 \cb1 \strokec4 \
\
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 SEALEVELPRESSURE_HPA\cf4 \strokec4  (1013.25)\cb1 \
\
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 HEATER_PIN\cf4 \strokec4  \cf6 \strokec6 4\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 SETUP_BUTTON_PIN\cf4 \strokec4  \cf6 \strokec6 0\cf2 \strokec2   // BOOT button\cf4 \cb1 \strokec4 \
\
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 EEPROM_SIZE\cf4 \strokec4  \cf6 \strokec6 512\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 SSID_START\cf4 \strokec4  \cf6 \strokec6 0\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 PASS_START\cf4 \strokec4  \cf6 \strokec6 32\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 SSID_MAX_LENGTH\cf4 \strokec4  \cf6 \strokec6 32\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 PASS_MAX_LENGTH\cf4 \strokec4  \cf6 \strokec6 64\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 FREEZE_GUARD_ADDR\cf4 \strokec4  \cf6 \strokec6 96\cf2 \strokec2   // store freeze guard on/off\cf4 \cb1 \strokec4 \
\
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 DISPLAY_UPDATE_INTERVAL\cf4 \strokec4  \cf6 \strokec6 100\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 WIFI_DISPLAY_DURATION\cf4 \strokec4  \cf6 \strokec6 4000\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 HEADER_TOGGLE_INTERVAL\cf4 \strokec4  \cf6 \strokec6 4000\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 STATE_DISPLAY_DURATION\cf4 \strokec4  \cf6 \strokec6 4000\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 SENSOR_READ_INTERVAL\cf4 \strokec4  \cf6 \strokec6 2000\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 DISPLAY_TOGGLE_INTERVAL\cf4 \strokec4  \cf6 \strokec6 4000\cf4 \cb1 \strokec4 \
\
\
\
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 BUTTON_RELEASE_GRACE_MS\cf4 \strokec4  \cf6 \strokec6 200\cf2 \strokec2   // Grace period for releasing buttons\cf4 \cb1 \strokec4 \
\
\
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 UP_BUTTON_PIN\cf4 \strokec4  \cf6 \strokec6 13\cf2 \strokec2       // GPIO13 for temp up/heat control\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 DOWN_BUTTON_PIN\cf4 \strokec4  \cf6 \strokec6 14\cf2 \strokec2     // GPIO14 for temp down/freeze guard\cf4 \cb1 \strokec4 \
\
\
\cf2 \cb3 \strokec2 // Button timing definitions\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 SHORT_PRESS_MS\cf4 \strokec4  \cf6 \strokec6 50\cf2 \strokec2       // Debounce time\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 LONG_PRESS_MS\cf4 \strokec4  \cf6 \strokec6 1000\cf2 \strokec2      // 1 second for heat/freeze toggles\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 WIFI_RESET_MS\cf4 \strokec4  \cf6 \strokec6 5000\cf2 \strokec2      // 5 seconds for WiFi reset\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 SLEEP_PRESS_MS\cf4 \strokec4  \cf6 \strokec6 2000\cf2 \strokec2      // 2 second hold for sleep mode\cf4 \cb1 \strokec4 \
\
\cf8 \cb3 \strokec8 const\cf4 \strokec4  \cf8 \strokec8 float\cf4 \strokec4  FREEZE_GUARD_TEMP = \cf6 \strokec6 38.0\cf4 \strokec4 ;\cf2 \strokec2  // 38deg\cf4 \cb1 \strokec4 \
\cf8 \cb3 \strokec8 const\cf4 \strokec4  \cf8 \strokec8 char\cf4 \strokec4 * www_username = \cf6 \strokec6 "admin"\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 const\cf4 \strokec4  \cf8 \strokec8 char\cf4 \strokec4 * www_password = \cf6 \strokec6 "RVthermostat"\cf4 \strokec4 ;\cb1 \
\
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 // Globals\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cb3 Adafruit_SSD1306 \cf7 \strokec7 display\cf9 \strokec9 (\cf4 \strokec4 SCREEN_WIDTH, SCREEN_HEIGHT, &\cf9 \strokec9 Wire\cf4 \strokec4 , OLED_RESET\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3 Adafruit_BME280 bme;\cb1 \
\cb3 WebServer \cf7 \strokec7 server\cf9 \strokec9 (\cf6 \strokec6 80\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\
\cf8 \cb3 \strokec8 float\cf4 \strokec4  currentTemp = \cf6 \strokec6 0.0\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 float\cf4 \strokec4  targetTemp  = \cf6 \strokec6 72.0\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 float\cf4 \strokec4  humidity    = \cf6 \strokec6 0.0\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  heaterEnabled = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  setupMode = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  isAP = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  freezeGuardEnabled = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\
\cb3 String storedSSID = \cf6 \strokec6 ""\cf4 \strokec4 ;\cb1 \
\cb3 String storedPassword = \cf6 \strokec6 ""\cf4 \strokec4 ;\cb1 \
\cb3 String wifiMessage = \cf6 \strokec6 ""\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  displayInitialized = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  showingWifiConnected = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  showingHumidity = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  showingSSID = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  showingStateChange = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cb3 String stateChangeMessage = \cf6 \strokec6 ""\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 uint8_t\cf4 \strokec4  displayBrightness = \cf6 \strokec6 255\cf4 \strokec4 ;\cb1 \
\
\cf8 \cb3 \strokec8 unsigned\cf4 \strokec4  \cf8 \strokec8 long\cf4 \strokec4  wifiConnectedDisplayTime = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 unsigned\cf4 \strokec4  \cf8 \strokec8 long\cf4 \strokec4  headerToggleTime = -\cf6 \strokec6 4000\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 unsigned\cf4 \strokec4  \cf8 \strokec8 long\cf4 \strokec4  stateChangeTime = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 unsigned\cf4 \strokec4  \cf8 \strokec8 long\cf4 \strokec4  displayToggleTime = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\
\
\cf2 \cb3 \strokec2 //smoothing samples of temp reading\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 SAMPLES\cf4 \strokec4  \cf6 \strokec6 10\cf4 \cb1 \strokec4 \
\cf8 \cb3 \strokec8 float\cf4 \strokec4  \cf7 \strokec7 tempReadings\cf4 \strokec4 [SAMPLES];\cb1 \
\cf8 \cb3 \strokec8 float\cf4 \strokec4  \cf7 \strokec7 humReadings\cf4 \strokec4 [SAMPLES];\cb1 \
\cf8 \cb3 \strokec8 int\cf4 \strokec4  readIndex = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\
\
\cf8 \cb3 \strokec8 static\cf4 \strokec4  \cf8 \strokec8 unsigned\cf4 \strokec4  \cf8 \strokec8 long\cf4 \strokec4  sleepStartTime = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\
\cf8 \cb3 \strokec8 int\cf4 \strokec4  ipScrollPosition = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 unsigned\cf4 \strokec4  \cf8 \strokec8 long\cf4 \strokec4  lastIpScroll = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 IP_DISPLAY_WIDTH\cf4 \strokec4  \cf6 \strokec6 15\cf2 \strokec2   // Characters that fit before WiFi bars\cf4 \cb1 \strokec4 \
\
\
\
\cf2 \cb3 \strokec2 // Button state tracking\cf4 \cb1 \strokec4 \
\cf8 \cb3 \strokec8 unsigned\cf4 \strokec4  \cf8 \strokec8 long\cf4 \strokec4  upButtonStart = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 unsigned\cf4 \strokec4  \cf8 \strokec8 long\cf4 \strokec4  downButtonStart = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  lastUpState = HIGH;\cb1 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  lastDownState = HIGH;\cb1 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  longPressHandled = \cf6 \strokec6 false\cf4 \strokec4 ;\cf2 \strokec2   // Prevents multiple triggers during long press\cf4 \cb1 \strokec4 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  displaySleepMode = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\
\
\cf2 \cb3 \strokec2 //tineout for OLED protection\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 #define\cf4 \strokec4  \cf7 \strokec7 DISPLAY_TIMEOUT\cf4 \strokec4  \cf6 \strokec6 300000\cf2 \strokec2   // 5 minute until sleep\cf4 \cb1 \strokec4 \
\
\cf8 \cb3 \strokec8 unsigned\cf4 \strokec4  \cf8 \strokec8 long\cf4 \strokec4  lastActivityTime = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  autoSleepEnabled = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\
\
\
\cf2 \cb3 \strokec2 //part2\cf4 \cb1 \strokec4 \
\
\
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 // Function Prototypes\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  \cf7 \strokec7 initializeDisplay\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 updateDisplay\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 showSetupScreen\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 showWiFiConnectedScreen\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 loadWiFiCredentials\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 saveWiFiCredentials\cf9 \strokec9 (\cf4 \strokec4 String \cf9 \strokec9 ssid\cf4 \strokec4 , String \cf9 \strokec9 password)\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 enterSetupMode\cf9 \strokec9 (\cf4 \strokec4 String \cf9 \strokec9 reason)\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 setupNormalMode\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleRoot\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleWiFiSetup\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleTarget\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleToggle\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleBrightness\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleReset\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleData\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleFreezeGuard\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 saveFreezeGuardState\cf9 \strokec9 (\cf8 \strokec8 bool\cf4 \strokec4  \cf9 \strokec9 enabled)\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 loadFreezeGuardState\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleButtons\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\
\
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 // Setup & Loop\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\
\
\
\
\
\
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 setup\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 begin\cf9 \strokec9 (\cf6 \strokec6 115200\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "Starting Thermostat..."\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\
\cb3   \cf7 \strokec7 Wire\cf4 \strokec4 .\cf7 \strokec7 begin\cf9 \strokec9 ()\cf4 \strokec4 ;\cf2 \strokec2  // Make sure this is before BME280 init\cf4 \cb1 \strokec4 \
\cb3   \cb1 \
\cf2 \cb3 \strokec2   // I2C Scanner\cf4 \cb1 \strokec4 \
\cb3   byte error, address;\cb1 \
\cb3   \cf7 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "Scanning I2C addresses..."\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf5 \strokec5 for\cf9 \strokec9 (\cf4 \strokec4 address = \cf6 \strokec6 1\cf4 \strokec4 ; address < \cf6 \strokec6 127\cf4 \strokec4 ; address++ \cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 Wire\cf4 \strokec4 .\cf7 \strokec7 beginTransmission\cf9 \strokec9 (\cf4 \strokec4 address\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     error = \cf7 \strokec7 Wire\cf4 \strokec4 .\cf7 \strokec7 endTransmission\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 error == \cf6 \strokec6 0\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       \cf7 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "I2C device found at address 0x"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 address < \cf6 \strokec6 16\cf9 \strokec9 )\cf4 \strokec4  \cf7 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "0"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       \cf7 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf4 \strokec4 address, HEX\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2   // Try both common BME280 addresses\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 // In setup(), replace the BME280 initialization with:\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 // Set BME280 to forced mode for better reliability\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "\\nInitializing BME280..."\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  status = \cf7 \strokec7 bme\cf4 \strokec4 .\cf7 \strokec7 begin\cf9 \strokec9 (\cf4 \strokec4 0x\cf6 \strokec6 76\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cf5 \cb3 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !status\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "Could not find BME280 at 0x76, trying 0x77..."\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   status = \cf7 \strokec7 bme\cf4 \strokec4 .\cf7 \strokec7 begin\cf9 \strokec9 (\cf4 \strokec4 0x\cf6 \strokec6 77\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !status\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "Could not find BME280!"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 while\cf9 \strokec9 (\cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "BME280 initialized successfully!"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\
\
\
\
\cf5 \cb3 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 begin\cf9 \strokec9 (\cf4 \strokec4 SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "SSD1306 failed"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf5 \strokec5 return\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\
\
\cf2 \cb3 \strokec2 // Set the default sensing mode\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7 bme\cf4 \strokec4 .\cf7 \strokec7 setSampling\cf9 \strokec9 (\cf4 \strokec4 Adafruit_BME280::MODE_NORMAL,\cb1 \
\cb3                 Adafruit_BME280::SAMPLING_X1,\cf2 \strokec2  // temperature\cf4 \cb1 \strokec4 \
\cb3                 Adafruit_BME280::SAMPLING_X1,\cf2 \strokec2  // pressure\cf4 \cb1 \strokec4 \
\cb3                 Adafruit_BME280::SAMPLING_X1,\cf2 \strokec2  // humidity\cf4 \cb1 \strokec4 \
\cb3                 Adafruit_BME280::FILTER_OFF\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\
\
\
\
\cb3   \cf7 \strokec7 pinMode\cf9 \strokec9 (\cf4 \strokec4 UP_BUTTON_PIN, INPUT_PULLUP\cf9 \strokec9 )\cf4 \strokec4 ;\cf2 \strokec2     // GPIO13\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 pinMode\cf9 \strokec9 (\cf4 \strokec4 DOWN_BUTTON_PIN, INPUT_PULLUP\cf9 \strokec9 )\cf4 \strokec4 ;\cf2 \strokec2   // GPIO14\cf4 \cb1 \strokec4 \
\
\
\
\cb3   \cb1 \
\cb3   \cf7 \strokec7 pinMode\cf9 \strokec9 (\cf4 \strokec4 HEATER_PIN, OUTPUT\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 digitalWrite\cf9 \strokec9 (\cf4 \strokec4 HEATER_PIN, LOW\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 pinMode\cf9 \strokec9 (\cf4 \strokec4 SETUP_BUTTON_PIN, INPUT_PULLUP\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 initializeDisplay\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 loadFreezeGuardState\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\
\cb3   \cf7 \strokec7 loadWiFiCredentials\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf7 \strokec7 storedSSID\cf4 \strokec4 .\cf7 \strokec7 length\cf9 \strokec9 ()\cf4 \strokec4  < \cf6 \strokec6 2\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 enterSetupMode\cf9 \strokec9 (\cf6 \strokec6 "No saved WiFi"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     wifiMessage = \cf6 \strokec6 "Connecting to: "\cf4 \strokec4  + storedSSID;\cb1 \
\cb3     \cf7 \strokec7 updateDisplay\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 WiFi\cf4 \strokec4 .\cf7 \strokec7 begin\cf9 \strokec9 (\cf7 \strokec7 storedSSID\cf4 \strokec4 .\cf7 \strokec7 c_str\cf9 \strokec9 ()\cf4 \strokec4 , \cf7 \strokec7 storedPassword\cf4 \strokec4 .\cf7 \strokec7 c_str\cf9 \strokec9 ())\cf4 \strokec4 ;\cb1 \
\
\cb3     \cf8 \strokec8 int\cf4 \strokec4  attempts = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 while\cf4 \strokec4  \cf9 \strokec9 (\cf7 \strokec7 WiFi\cf4 \strokec4 .\cf7 \strokec7 status\cf9 \strokec9 ()\cf4 \strokec4  != WL_CONNECTED && attempts < \cf6 \strokec6 30\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       \cf7 \strokec7 delay\cf9 \strokec9 (\cf6 \strokec6 500\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       attempts++;\cb1 \
\cb3       String dots = \cf6 \strokec6 ""\cf4 \strokec4 ;\cb1 \
\cb3       \cf5 \strokec5 for\cf9 \strokec9 (\cf8 \strokec8 int\cf4 \strokec4  i = \cf6 \strokec6 0\cf4 \strokec4 ; i < \cf9 \strokec9 (\cf4 \strokec4 attempts % \cf6 \strokec6 4\cf9 \strokec9 )\cf4 \strokec4 ; i++\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3         dots += \cf6 \strokec6 "."\cf4 \strokec4 ;\cb1 \
\cb3       \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3       wifiMessage = \cf6 \strokec6 "Connecting to: "\cf4 \strokec4  + storedSSID + \cf6 \strokec6 " "\cf4 \strokec4  + dots;\cb1 \
\cb3       \cf7 \strokec7 updateDisplay\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf7 \strokec7 WiFi\cf4 \strokec4 .\cf7 \strokec7 status\cf9 \strokec9 ()\cf4 \strokec4  == WL_CONNECTED\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       \cf7 \strokec7 setupNormalMode\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\
\cb3     \cf9 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       \cf7 \strokec7 enterSetupMode\cf9 \strokec9 (\cf6 \strokec6 "WiFi Connect Failed"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\
\
\
\
\
\
\
\
\
\
\cf2 \cb3 \strokec2 // This should be your loop() function\cf4 \cb1 \strokec4 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 loop\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\
\cb3   \cf7 \strokec7 handleButtons\cf9 \strokec9 ()\cf4 \strokec4 ; \cb1 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !setupMode && \cf7 \strokec7 digitalRead\cf9 \strokec9 (\cf4 \strokec4 SETUP_BUTTON_PIN\cf9 \strokec9 )\cf4 \strokec4  == LOW\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 delay\cf9 \strokec9 (\cf6 \strokec6 50\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf7 \strokec7 digitalRead\cf9 \strokec9 (\cf4 \strokec4 SETUP_BUTTON_PIN\cf9 \strokec9 )\cf4 \strokec4  == LOW\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       \cf7 \strokec7 saveWiFiCredentials\cf9 \strokec9 (\cf6 \strokec6 ""\cf4 \strokec4 , \cf6 \strokec6 ""\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       \cf7 \strokec7 ESP\cf4 \strokec4 .\cf7 \strokec7 restart\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cb3   \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 handleClient\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !setupMode\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf8 \strokec8 unsigned\cf4 \strokec4  \cf8 \strokec8 long\cf4 \strokec4  now = \cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 showingWifiConnected && \cf9 \strokec9 (\cf4 \strokec4 now - wifiConnectedDisplayTime >= WIFI_DISPLAY_DURATION\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       \cf7 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "Transitioning from WiFi screen to main display..."\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       showingWifiConnected = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cb3       \cf7 \strokec7 updateDisplay\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cb3     \cf8 \strokec8 static\cf4 \strokec4  \cf8 \strokec8 unsigned\cf4 \strokec4  \cf8 \strokec8 long\cf4 \strokec4  lastDisplayUpdate = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !showingWifiConnected && \cf9 \strokec9 (\cf4 \strokec4 now - lastDisplayUpdate >= DISPLAY_UPDATE_INTERVAL\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       \cf7 \strokec7 updateDisplay\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3       lastDisplayUpdate = now;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\
\
\
\
\
\cf5 \cb3 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 autoSleepEnabled && !displaySleepMode && \cf9 \strokec9 (\cf4 \strokec4 now - lastActivityTime > DISPLAY_TIMEOUT\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   displaySleepMode = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 clearDisplay\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 display\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\
\
\
\
\
\
\
\cb3     \cf8 \strokec8 static\cf4 \strokec4  \cf8 \strokec8 unsigned\cf4 \strokec4  \cf8 \strokec8 long\cf4 \strokec4  lastRead = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\cf8 \cb3 \strokec8 static\cf4 \strokec4  \cf8 \strokec8 bool\cf4 \strokec4  sensorInit = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cf5 \cb3 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 sensorInit\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf8 \strokec8 float\cf4 \strokec4  initTemp = \cf7 \strokec7 bme\cf4 \strokec4 .\cf7 \strokec7 readTemperature\cf9 \strokec9 ()\cf4 \strokec4  * \cf6 \strokec6 9\cf4 \strokec4 /\cf6 \strokec6 5\cf4 \strokec4  + \cf6 \strokec6 32\cf4 \strokec4 ;\cb1 \
\cb3   \cf5 \strokec5 for\cf9 \strokec9 (\cf8 \strokec8 int\cf4 \strokec4  i = \cf6 \strokec6 0\cf4 \strokec4 ; i < SAMPLES; i++\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 tempReadings\cf4 \strokec4 [i] = initTemp;\cb1 \
\cb3     \cf7 \strokec7 humReadings\cf4 \strokec4 [i] = \cf7 \strokec7 bme\cf4 \strokec4 .\cf7 \strokec7 readHumidity\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 delay\cf9 \strokec9 (\cf6 \strokec6 8000\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   sensorInit = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 now - lastRead >= SENSOR_READ_INTERVAL\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf8 \strokec8 float\cf4 \strokec4  newTemp = \cf7 \strokec7 bme\cf4 \strokec4 .\cf7 \strokec7 readTemperature\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf8 \strokec8 float\cf4 \strokec4  newHumidity = \cf7 \strokec7 bme\cf4 \strokec4 .\cf7 \strokec7 readHumidity\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cb1 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 isnan\cf9 \strokec9 (\cf4 \strokec4 newTemp\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 tempReadings\cf4 \strokec4 [readIndex] = newTemp * \cf6 \strokec6 9\cf4 \strokec4 /\cf6 \strokec6 5\cf4 \strokec4  + \cf6 \strokec6 32\cf4 \strokec4 ;\cb1 \
\cb3     \cf8 \strokec8 float\cf4 \strokec4  sum = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 for\cf9 \strokec9 (\cf8 \strokec8 int\cf4 \strokec4  i = \cf6 \strokec6 0\cf4 \strokec4 ; i < SAMPLES; i++\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       sum += \cf7 \strokec7 tempReadings\cf4 \strokec4 [i];\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3     currentTemp = sum / SAMPLES;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cb1 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 isnan\cf9 \strokec9 (\cf4 \strokec4 newHumidity\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 humReadings\cf4 \strokec4 [readIndex] = newHumidity;\cb1 \
\cb3     \cf8 \strokec8 float\cf4 \strokec4  sum = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 for\cf9 \strokec9 (\cf8 \strokec8 int\cf4 \strokec4  i = \cf6 \strokec6 0\cf4 \strokec4 ; i < SAMPLES; i++\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       sum += \cf7 \strokec7 humReadings\cf4 \strokec4 [i];\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3     humidity = sum / SAMPLES;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cb1 \
\cb3   readIndex = \cf9 \strokec9 (\cf4 \strokec4 readIndex + \cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4  % SAMPLES;\cb1 \
\cb3   \cb1 \
\cf2 \cb3 \strokec2   // Control heater\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 freezeGuardEnabled\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 currentTemp < FREEZE_GUARD_TEMP\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       \cf7 \strokec7 digitalWrite\cf9 \strokec9 (\cf4 \strokec4 HEATER_PIN, HIGH\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       heaterEnabled = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 currentTemp >= \cf9 \strokec9 (\cf4 \strokec4 FREEZE_GUARD_TEMP + \cf6 \strokec6 2.0\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       \cf7 \strokec7 digitalWrite\cf9 \strokec9 (\cf4 \strokec4 HEATER_PIN, LOW\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       heaterEnabled = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf9 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 heaterEnabled && currentTemp < targetTemp\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       \cf7 \strokec7 digitalWrite\cf9 \strokec9 (\cf4 \strokec4 HEATER_PIN, HIGH\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       \cf7 \strokec7 digitalWrite\cf9 \strokec9 (\cf4 \strokec4 HEATER_PIN, LOW\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cb1 \
\cb3   lastRead = now;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 //part3\cf4 \cb1 \strokec4 \
\
\
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 // Display\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cf8 \cb3 \strokec8 bool\cf4 \strokec4  \cf7 \strokec7 initializeDisplay\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !displayInitialized\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "Starting display init..."\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 begin\cf9 \strokec9 (\cf4 \strokec4 SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       \cf7 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "SSD1306 failed"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       \cf5 \strokec5 return\cf4 \strokec4  \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "SSD1306 success"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 clearDisplay\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setTextColor\cf9 \strokec9 (\cf4 \strokec4 WHITE\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     displayInitialized = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 return\cf4 \strokec4  \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 updateDisplay\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 initializeDisplay\cf9 \strokec9 ())\cf4 \strokec4  \cf5 \strokec5 return\cf4 \strokec4 ;\cb1 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 displaySleepMode\cf9 \strokec9 )\cf4 \strokec4  \cf5 \strokec5 return\cf4 \strokec4 ;\cf2 \strokec2   // Add this line here - early exit if sleeping\cf4 \cb1 \strokec4 \
\
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 clearDisplay\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setTextColor\cf9 \strokec9 (\cf4 \strokec4 WHITE\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setTextSize\cf9 \strokec9 (\cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\
\cf5 \cb3 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 isAP && setupMode\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf2 \strokec2   // Only show scrolling message in setup mode\cf4 \cb1 \strokec4 \
\cb3     \cf8 \strokec8 static\cf4 \strokec4  \cf8 \strokec8 unsigned\cf4 \strokec4  \cf8 \strokec8 long\cf4 \strokec4  lastScroll = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\cb3     \cf8 \strokec8 static\cf4 \strokec4  \cf8 \strokec8 int\cf4 \strokec4  scrollPosition = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\cb3     \cf8 \strokec8 unsigned\cf4 \strokec4  \cf8 \strokec8 long\cf4 \strokec4  now = \cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 now - lastScroll > \cf6 \strokec6 100\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       scrollPosition++;\cb1 \
\cb3       \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 scrollPosition > \cf7 \strokec7 wifiMessage\cf4 \strokec4 .\cf7 \strokec7 length\cf9 \strokec9 ()\cf4 \strokec4  * \cf6 \strokec6 6\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3         scrollPosition = -\cf6 \strokec6 128\cf4 \strokec4 ;\cb1 \
\cb3       \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3       lastScroll = now;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf4 \strokec4 -scrollPosition, \cf6 \strokec6 0\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf4 \strokec4 wifiMessage\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4  - headerToggleTime > HEADER_TOGGLE_INTERVAL\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       showingSSID = !showingSSID;\cb1 \
\cb3       headerToggleTime = \cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\
\cf2 \cb3 \strokec2     //part4\cf4 \cb1 \strokec4 \
\
\
\cf7 \cb3 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf6 \strokec6 0\cf4 \strokec4 , \cf6 \strokec6 0\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cf5 \cb3 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 showingSSID\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "WiFi: "\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf4 \strokec4 storedSSID\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "IP: "\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     String ip = \cf7 \strokec7 WiFi\cf4 \strokec4 .\cf7 \strokec7 localIP\cf9 \strokec9 ()\cf4 \strokec4 .\cf7 \strokec7 toString\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf2 \cb3 \strokec2     // If IP is too long to fit\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf7 \strokec7 ip\cf4 \strokec4 .\cf7 \strokec7 length\cf9 \strokec9 ()\cf4 \strokec4  > IP_DISPLAY_WIDTH\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3         \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4  - lastIpScroll > \cf6 \strokec6 500\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf2 \strokec2   // Scroll every 500ms\cf4 \cb1 \strokec4 \
\cb3             ipScrollPosition++;\cb1 \
\cb3             \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 ipScrollPosition > \cf7 \strokec7 ip\cf4 \strokec4 .\cf7 \strokec7 length\cf9 \strokec9 ()\cf4 \strokec4  - IP_DISPLAY_WIDTH\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3                 ipScrollPosition = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\cb3             \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3             lastIpScroll = \cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3         \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3         \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf7 \strokec7 ip\cf4 \strokec4 .\cf7 \strokec7 substring\cf9 \strokec9 (\cf4 \strokec4 ipScrollPosition, ipScrollPosition + IP_DISPLAY_WIDTH\cf9 \strokec9 ))\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3         \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf4 \strokec4 ip\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3     \cb1 \
\cf7 \cb3 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf6 \strokec6 95\cf4 \strokec4 , \cf6 \strokec6 0\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf8 \strokec8 int\cf4 \strokec4  rssi = \cf7 \strokec7 WiFi\cf4 \strokec4 .\cf7 \strokec7 RSSI\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf2 \cb3 \strokec2     // 5 bars for better signal resolution\cf4 \cb1 \strokec4 \
\cb3     \cf8 \strokec8 int\cf4 \strokec4  bars = \cf6 \strokec6 0\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 rssi > -\cf6 \strokec6 60\cf9 \strokec9 )\cf4 \strokec4  bars = \cf6 \strokec6 5\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 else\cf4 \strokec4  \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 rssi > -\cf6 \strokec6 67\cf9 \strokec9 )\cf4 \strokec4  bars = \cf6 \strokec6 4\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 else\cf4 \strokec4  \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 rssi > -\cf6 \strokec6 75\cf9 \strokec9 )\cf4 \strokec4  bars = \cf6 \strokec6 3\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 else\cf4 \strokec4  \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 rssi > -\cf6 \strokec6 85\cf9 \strokec9 )\cf4 \strokec4  bars = \cf6 \strokec6 2\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 else\cf4 \strokec4  bars = \cf6 \strokec6 1\cf4 \strokec4 ;\cb1 \
\cb3     \cb1 \
\cf2 \cb3 \strokec2     // Draw 5 positions\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 bars == \cf6 \strokec6 5\cf9 \strokec9 )\cf4 \strokec4  \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "|||||"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 else\cf4 \strokec4  \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 bars == \cf6 \strokec6 4\cf9 \strokec9 )\cf4 \strokec4  \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "||||."\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 else\cf4 \strokec4  \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 bars == \cf6 \strokec6 3\cf9 \strokec9 )\cf4 \strokec4  \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "|||.."\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 else\cf4 \strokec4  \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 bars == \cf6 \strokec6 2\cf9 \strokec9 )\cf4 \strokec4  \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "||..."\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 else\cf4 \strokec4  \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "|...."\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cf2 \cb3 \strokec2     // If freeze guard is enabled, show a note\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 freezeGuardEnabled\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf6 \strokec6 0\cf4 \strokec4 ,\cf6 \strokec6 16\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "FREEZE GUARD ON"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 showingStateChange && \cf9 \strokec9 (\cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4  - stateChangeTime < STATE_DISPLAY_DURATION\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setTextSize\cf9 \strokec9 (\cf6 \strokec6 3\cf9 \strokec9 )\cf4 \strokec4 ;\cf2 \strokec2   // Make it much bigger - size 5\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf6 \strokec6 0\cf4 \strokec4 ,\cf6 \strokec6 25\cf9 \strokec9 )\cf4 \strokec4 ;\cf2 \strokec2   // Move right 15 pixels, up to 10 pixels\cf4 \cb1 \strokec4 \
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf4 \strokec4 stateChangeMessage\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       showingStateChange = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\
\cb3       \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4  - displayToggleTime >= DISPLAY_TOGGLE_INTERVAL\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3         showingHumidity = !showingHumidity;\cb1 \
\cb3         displayToggleTime = \cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3       \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setTextSize\cf9 \strokec9 (\cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf6 \strokec6 0\cf4 \strokec4 , \cf6 \strokec6 8\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "TEMP"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf6 \strokec6 70\cf4 \strokec4 , \cf6 \strokec6 8\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "TARGET"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\
\
\
\cf2 \cb3 \strokec2       //part 5\cf4 \cb1 \strokec4 \
\
\
\
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setTextSize\cf9 \strokec9 (\cf6 \strokec6 2\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf6 \strokec6 0\cf4 \strokec4 , \cf6 \strokec6 25\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 showingHumidity\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3         \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 isnan\cf9 \strokec9 (\cf4 \strokec4 humidity\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3           \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf4 \strokec4 humidity, \cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3           \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "%"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3         \cf9 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3           \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "FAULT"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3         \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3       \cf9 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3         \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 isnan\cf9 \strokec9 (\cf4 \strokec4 currentTemp\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3           \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf4 \strokec4 currentTemp, \cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3         \cf9 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3           \cf8 \strokec8 int\cf4 \strokec4  phase = \cf9 \strokec9 (\cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4  % \cf6 \strokec6 6000\cf9 \strokec9 )\cf4 \strokec4  / \cf6 \strokec6 2000\cf4 \strokec4 ;\cf2 \strokec2   // 6 seconds total cycle, 2 seconds each\cf4 \cb1 \strokec4 \
\cb3           \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 phase == \cf6 \strokec6 0\cf9 \strokec9 )\cf4 \strokec4  \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "FAULT"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3           \cf5 \strokec5 else\cf4 \strokec4  \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 phase == \cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4  \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "TEMP"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3           \cf5 \strokec5 else\cf4 \strokec4  \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "SNSR"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3         \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3       \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf7 \cb3 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf6 \strokec6 70\cf4 \strokec4 , \cf6 \strokec6 25\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 freezeGuardEnabled\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3         \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "38.0"\cf9 \strokec9 )\cf4 \strokec4 ;\cf2 \strokec2   // Show freeze guard temp when active\cf4 \cb1 \strokec4 \
\cb3       \cf9 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3         \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf4 \strokec4 targetTemp, \cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4 ;\cf2 \strokec2   // Show normal target temp\cf4 \cb1 \strokec4 \
\cb3       \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setTextSize\cf9 \strokec9 (\cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf6 \strokec6 0\cf4 \strokec4 , \cf6 \strokec6 45\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf6 \strokec6 "HEATER: "\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 print\cf9 \strokec9 (\cf4 \strokec4 heaterEnabled ? \cf6 \strokec6 "ON"\cf4 \strokec4  : \cf6 \strokec6 "OFF"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 display\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 showSetupScreen\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 initializeDisplay\cf9 \strokec9 ())\cf4 \strokec4  \cf5 \strokec5 return\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 clearDisplay\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setTextSize\cf9 \strokec9 (\cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf6 \strokec6 0\cf4 \strokec4 , \cf6 \strokec6 0\cf9 \strokec9 )\cf4 \strokec4 ;  \cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "SETUP MODE"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf6 \strokec6 0\cf4 \strokec4 , \cf6 \strokec6 16\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "WiFi: RV-THERMOSTAT"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf6 \strokec6 0\cf4 \strokec4 , \cf6 \strokec6 26\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "Pass: RVthermostat"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf6 \strokec6 0\cf4 \strokec4 , \cf6 \strokec6 36\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "IP: 192.168.4.1"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf6 \strokec6 0\cf4 \strokec4 , \cf6 \strokec6 46\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "User: admin"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf6 \strokec6 0\cf4 \strokec4 , \cf6 \strokec6 56\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "Pass: RVthermostat"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 display\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\
\
\cf2 \cb3 \strokec2 //part 6\cf4 \cb1 \strokec4 \
\
\
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 showWiFiConnectedScreen\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 initializeDisplay\cf9 \strokec9 ())\cf4 \strokec4  \cf5 \strokec5 return\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 clearDisplay\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setTextSize\cf9 \strokec9 (\cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 setCursor\cf9 \strokec9 (\cf6 \strokec6 0\cf4 \strokec4 ,\cf6 \strokec6 0\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "WiFi Connected!"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "SSID: "\cf4 \strokec4  + storedSSID\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "IP: "\cf4 \strokec4  + \cf7 \strokec7 WiFi\cf4 \strokec4 .\cf7 \strokec7 localIP\cf9 \strokec9 ()\cf4 \strokec4 .\cf7 \strokec7 toString\cf9 \strokec9 ())\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 display\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 // WiFi Functions\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 loadWiFiCredentials\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 EEPROM\cf4 \strokec4 .\cf7 \strokec7 begin\cf9 \strokec9 (\cf4 \strokec4 EEPROM_SIZE\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   storedSSID = \cf6 \strokec6 ""\cf4 \strokec4 ;\cb1 \
\cb3   \cf5 \strokec5 for\cf4 \strokec4  \cf9 \strokec9 (\cf8 \strokec8 int\cf4 \strokec4  i = \cf6 \strokec6 0\cf4 \strokec4 ; i < SSID_MAX_LENGTH; i++\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf8 \strokec8 char\cf4 \strokec4  c = \cf7 \strokec7 EEPROM\cf4 \strokec4 .\cf7 \strokec7 read\cf9 \strokec9 (\cf4 \strokec4 SSID_START + i\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 c != \cf6 \strokec6 0\cf9 \strokec9 )\cf4 \strokec4  storedSSID += c;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   storedPassword = \cf6 \strokec6 ""\cf4 \strokec4 ;\cb1 \
\cb3   \cf5 \strokec5 for\cf4 \strokec4  \cf9 \strokec9 (\cf8 \strokec8 int\cf4 \strokec4  i = \cf6 \strokec6 0\cf4 \strokec4 ; i < PASS_MAX_LENGTH; i++\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf8 \strokec8 char\cf4 \strokec4  c = \cf7 \strokec7 EEPROM\cf4 \strokec4 .\cf7 \strokec7 read\cf9 \strokec9 (\cf4 \strokec4 PASS_START + i\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 c != \cf6 \strokec6 0\cf9 \strokec9 )\cf4 \strokec4  storedPassword += c;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 EEPROM\cf4 \strokec4 .\cf7 \strokec7 end\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 saveWiFiCredentials\cf9 \strokec9 (\cf4 \strokec4 String \cf9 \strokec9 ssid\cf4 \strokec4 , String \cf9 \strokec9 password)\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 EEPROM\cf4 \strokec4 .\cf7 \strokec7 begin\cf9 \strokec9 (\cf4 \strokec4 EEPROM_SIZE\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf5 \strokec5 for\cf4 \strokec4  \cf9 \strokec9 (\cf8 \strokec8 int\cf4 \strokec4  i = \cf6 \strokec6 0\cf4 \strokec4 ; i < SSID_MAX_LENGTH; i++\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 EEPROM\cf4 \strokec4 .\cf7 \strokec7 write\cf9 \strokec9 (\cf4 \strokec4 SSID_START + i, \cf9 \strokec9 (\cf4 \strokec4 i < \cf7 \strokec7 ssid\cf4 \strokec4 .\cf7 \strokec7 length\cf9 \strokec9 ()\cf4 \strokec4  ? \cf7 \strokec7 ssid\cf4 \strokec4 [i] : \cf6 \strokec6 0\cf9 \strokec9 ))\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 for\cf4 \strokec4  \cf9 \strokec9 (\cf8 \strokec8 int\cf4 \strokec4  i = \cf6 \strokec6 0\cf4 \strokec4 ; i < PASS_MAX_LENGTH; i++\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 EEPROM\cf4 \strokec4 .\cf7 \strokec7 write\cf9 \strokec9 (\cf4 \strokec4 PASS_START + i, \cf9 \strokec9 (\cf4 \strokec4 i < \cf7 \strokec7 password\cf4 \strokec4 .\cf7 \strokec7 length\cf9 \strokec9 ()\cf4 \strokec4  ? \cf7 \strokec7 password\cf4 \strokec4 [i] : \cf6 \strokec6 0\cf9 \strokec9 ))\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 EEPROM\cf4 \strokec4 .\cf7 \strokec7 commit\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 EEPROM\cf4 \strokec4 .\cf7 \strokec7 end\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 enterSetupMode\cf9 \strokec9 (\cf4 \strokec4 String \cf9 \strokec9 reason)\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf4 \strokec4 reason + \cf6 \strokec6 " - entering setup mode"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   setupMode = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3   isAP = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3   displaySleepMode = \cf6 \strokec6 false\cf4 \strokec4 ;\cf2 \strokec2   // Ensure display is on\cf4 \cb1 \strokec4 \
\cb3   \cb1 \
\cb3   \cf7 \strokec7 WiFi\cf4 \strokec4 .\cf7 \strokec7 disconnect\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 WiFi\cf4 \strokec4 .\cf7 \strokec7 mode\cf9 \strokec9 (\cf4 \strokec4 WIFI_AP\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf7 \strokec7 WiFi\cf4 \strokec4 .\cf7 \strokec7 softAP\cf9 \strokec9 (\cf6 \strokec6 "RV-THERMOSTAT"\cf4 \strokec4 , \cf6 \strokec6 "RVthermostat"\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "AP Started Successfully"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cb1 \
\cf2 \cb3 \strokec2     // Show setup screen first and make it stick\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 showSetupScreen\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3     wifiMessage = \cf6 \strokec6 "SETUP MODE - Connect to: RV-THERMOSTAT (RVthermostat) -> 192.168.4.1"\cf4 \strokec4 ;\cb1 \
\cb3     \cb1 \
\cf2 \cb3 \strokec2     // Simple, flat route setup\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 on\cf9 \strokec9 (\cf6 \strokec6 "/"\cf4 \strokec4 , handleWiFiSetup\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 on\cf9 \strokec9 (\cf6 \strokec6 "/control"\cf4 \strokec4 , handleRoot\cf9 \strokec9 )\cf4 \strokec4 ;\cf2 \strokec2   // Direct to main control interface\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 on\cf9 \strokec9 (\cf6 \strokec6 "/target"\cf4 \strokec4 , handleTarget\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 on\cf9 \strokec9 (\cf6 \strokec6 "/toggle"\cf4 \strokec4 , handleToggle\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 on\cf9 \strokec9 (\cf6 \strokec6 "/reset"\cf4 \strokec4 , handleReset\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 on\cf9 \strokec9 (\cf6 \strokec6 "/brightness"\cf4 \strokec4 , handleBrightness\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 on\cf9 \strokec9 (\cf6 \strokec6 "/data"\cf4 \strokec4 , handleData\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 on\cf9 \strokec9 (\cf6 \strokec6 "/freezeguard"\cf4 \strokec4 , handleFreezeGuard\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 begin\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 setupNormalMode\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   wifiMessage = \cf6 \strokec6 "WIFI: "\cf4 \strokec4  + storedSSID;\cb1 \
\cb3   \cf7 \strokec7 Serial\cf4 \strokec4 .\cf7 \strokec7 println\cf9 \strokec9 (\cf6 \strokec6 "Connected! IP: "\cf4 \strokec4  + \cf7 \strokec7 WiFi\cf4 \strokec4 .\cf7 \strokec7 localIP\cf9 \strokec9 ()\cf4 \strokec4 .\cf7 \strokec7 toString\cf9 \strokec9 ())\cf4 \strokec4 ;\cb1 \
\
\cb3   \cf7 \strokec7 showWiFiConnectedScreen\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   showingWifiConnected = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3   wifiConnectedDisplayTime = \cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\
\cb3   setupMode = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cb3   isAP = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cb3   headerToggleTime = \cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   showingSSID = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\
\cb3   \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 on\cf9 \strokec9 (\cf6 \strokec6 "/"\cf4 \strokec4 , handleRoot\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 on\cf9 \strokec9 (\cf6 \strokec6 "/target"\cf4 \strokec4 , handleTarget\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 on\cf9 \strokec9 (\cf6 \strokec6 "/toggle"\cf4 \strokec4 , handleToggle\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 on\cf9 \strokec9 (\cf6 \strokec6 "/reset"\cf4 \strokec4 , handleReset\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 on\cf9 \strokec9 (\cf6 \strokec6 "/brightness"\cf4 \strokec4 , handleBrightness\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 on\cf9 \strokec9 (\cf6 \strokec6 "/data"\cf4 \strokec4 , handleData\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 on\cf9 \strokec9 (\cf6 \strokec6 "/freezeguard"\cf4 \strokec4 , handleFreezeGuard\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 begin\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 // Freeze Guard State\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 saveFreezeGuardState\cf9 \strokec9 (\cf8 \strokec8 bool\cf4 \strokec4  \cf9 \strokec9 enabled)\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 EEPROM\cf4 \strokec4 .\cf7 \strokec7 begin\cf9 \strokec9 (\cf4 \strokec4 EEPROM_SIZE\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 EEPROM\cf4 \strokec4 .\cf7 \strokec7 write\cf9 \strokec9 (\cf4 \strokec4 FREEZE_GUARD_ADDR, \cf9 \strokec9 (\cf4 \strokec4 enabled ? \cf6 \strokec6 1\cf4 \strokec4  : \cf6 \strokec6 0\cf9 \strokec9 ))\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 EEPROM\cf4 \strokec4 .\cf7 \strokec7 commit\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 EEPROM\cf4 \strokec4 .\cf7 \strokec7 end\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 loadFreezeGuardState\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 EEPROM\cf4 \strokec4 .\cf7 \strokec7 begin\cf9 \strokec9 (\cf4 \strokec4 EEPROM_SIZE\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   freezeGuardEnabled = \cf9 \strokec9 (\cf7 \strokec7 EEPROM\cf4 \strokec4 .\cf7 \strokec7 read\cf9 \strokec9 (\cf4 \strokec4 FREEZE_GUARD_ADDR\cf9 \strokec9 )\cf4 \strokec4  == \cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 EEPROM\cf4 \strokec4 .\cf7 \strokec7 end\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 // Web Handlers\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 //------------------------------------------------------------------------------\cf4 \cb1 \strokec4 \
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleRoot\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 authenticate\cf9 \strokec9 (\cf4 \strokec4 www_username, www_password\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 sendHeader\cf9 \strokec9 (\cf6 \strokec6 "WWW-Authenticate"\cf4 \strokec4 , \cf6 \strokec6 "Basic realm=\\"RV Control Login\\""\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 sendHeader\cf9 \strokec9 (\cf6 \strokec6 "Cache-Control"\cf4 \strokec4 , \cf6 \strokec6 "no-store,no-cache,must-revalidate,max-age=0"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 sendHeader\cf9 \strokec9 (\cf6 \strokec6 "Cache-Control"\cf4 \strokec4 , \cf6 \strokec6 "post-check=0,pre-check=0"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 sendHeader\cf9 \strokec9 (\cf6 \strokec6 "Pragma"\cf4 \strokec4 , \cf6 \strokec6 "no-cache"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 sendHeader\cf9 \strokec9 (\cf6 \strokec6 "Expires"\cf4 \strokec4 , \cf6 \strokec6 "-1"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     String authPage = \cf6 \strokec6 "<!DOCTYPE html><html><head>"\cf4 \strokec4 ;\cb1 \
\cb3     authPage += \cf6 \strokec6 "<meta name='viewport' content='width=device-width,initial-scale=1'>"\cf4 \strokec4 ;\cb1 \
\cb3     authPage += \cf6 \strokec6 "<meta http-equiv='refresh' content='0'>"\cf4 \strokec4 ;\cf2 \strokec2   // Force refresh\cf4 \cb1 \strokec4 \
\cb3     authPage += \cf6 \strokec6 "<style>body\{font-family:-apple-system,sans-serif;text-align:center;padding:40px;\}</style>"\cf4 \strokec4 ;\cb1 \
\cb3     authPage += \cf6 \strokec6 "</head><body><h2>Authentication Required</h2>"\cf4 \strokec4 ;\cb1 \
\cb3     authPage += \cf6 \strokec6 "<script>if(navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome'))\{window.location.reload(true);\}</script>"\cf4 \strokec4 ;\cb1 \
\cb3     authPage += \cf6 \strokec6 "</body></html>"\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 send\cf9 \strokec9 (\cf6 \strokec6 401\cf4 \strokec4 , \cf6 \strokec6 "text/html"\cf4 \strokec4 , authPage\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 return\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\
\
\cf2 \cb3 \strokec2 //part 8\cf4 \cb1 \strokec4 \
\
\
\
\cf2 \cb3 \strokec2 // Advanced UI with freeze guard overlay + hold logic\cf4 \cb1 \strokec4 \
\cb3   \cb1 \
\
\
\
\cf2 \cb3 \strokec2 // Advanced UI with freeze guard overlay + hold logic\cf4 \cb1 \strokec4 \
\cb3   String html = \cf6 \strokec6 "<html><head>"\cf4 \strokec4 ;\cb1 \
\cb3   html += \cf6 \strokec6 "<meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no'>"\cf4 \strokec4 ;\cb1 \
\cb3   \cb1 \
\cb3  \cb1 \
\
\
\
\
\cb3  html += \cf6 \strokec6 "<style>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "*\{box-sizing:border-box;touch-action:manipulation;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;\}"\cf4 \strokec4 ;\cb1 \
\
\cb3 html += \cf6 \strokec6 ".s\{display:flex;align-items:center;gap:5px;margin:5px;\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".dot\{width:10px;height:10px;border-radius:50%;animation:blink 1s infinite;\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "@keyframes blink\{50%\{opacity:0.3\}\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".wifi-dots\{display:flex;gap:2px;\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".wifi-dot\{width:6px;height:6px;border-radius:50%;transition:background-color 0.3s;\}"\cf4 \strokec4 ;\cb1 \
\
\
\cb3 html += \cf6 \strokec6 "body\{font-family:-apple-system,BlinkMacSystemFont,sans-serif;margin:0;padding:16px;background:#f0f2f5;\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".card\{background:white;border-radius:20px;padding:24px;margin:0 auto;max-width:500px;box-shadow:0 2px 12px rgba(0,0,0,0.1);\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".temp\{font-size:72px;font-weight:700;margin:24px 0;text-align:center;\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".humidity\{font-size:20px;color:#666;margin:16px 0;text-align:center;\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".controls\{display:flex;align-items:center;justify-content:center;gap:20px;margin:32px 0;\}"\cf4 \strokec4 ;\cb1 \
\
\
\cb3 html += \cf6 \strokec6 ".btn\{width:60px;height:60px;font-size:32px;border:none;border-radius:12px;color:white;\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".btn-up\{background:#FF3B30;\}"\cf4 \strokec4 ;\cf2 \strokec2  // Red for up\cf4 \cb1 \strokec4 \
\cb3 html += \cf6 \strokec6 ".btn-down\{background:#007AFF;\}"\cf4 \strokec4 ;\cf2 \strokec2  // Blue for down\cf4 \cb1 \strokec4 \
\
\cb3 html += \cf6 \strokec6 ".target\{font-size:24px;font-weight:500;text-align:center;\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".toggle-container\{text-align:center;margin:32px 0;\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".toggle\{position:relative;display:inline-block;width:120px;height:60px;\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".toggle input\{opacity:0;width:0;height:0;\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".slider\{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.4s;border-radius:34px;\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".slider:before\{content:'';position:absolute;height:52px;width:52px;left:4px;bottom:4px;background:white;transition:.4s;border-radius:50%;\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "input:checked + .slider\{background:#FF3B30;\} input:checked + .slider:before\{transform:translateX(60px);\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".status\{text-align:center;margin-top:8px;font-size:18px;font-weight:500;\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".brightness-container\{text-align:center;margin:32px 0;\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "</style>"\cf4 \strokec4 ;\cb1 \
\
\cf2 \cb3 \strokec2   // Script\cf4 \cb1 \strokec4 \
\
\cb3 html += \cf6 \strokec6 "<script>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "function debounce(func,wait)\{let t;return function(...args)\{clearTimeout(t);t=setTimeout(()=>func.apply(this,args),wait);\}\}"\cf4 \strokec4 ;\cb1 \
\cf2 \cb3 \strokec2 //web wifi dots colors\cf4 \cb1 \strokec4 \
\cb3 html += \cf6 \strokec6 "function updateWifiDots(rssi)\{"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  const dots=[1,2,3,4,5];"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  let level = 0;"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  if(rssi > -50) level = 5;"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  else if(rssi > -60) level = 4;"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  else if(rssi > -70) level = 3;"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  else if(rssi > -80) level = 2;"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  else level = 1;"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  dots.forEach(i=>\{"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "    const dot=document.getElementById('wifi'+i);"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "    if(i<=level)\{"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "      const color=i===1?'#FF3B30':i===2?'#FF9500':i===3?'#FFCC00':i===4?'#99CC00':'#34C759';"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "      dot.style.background=color;"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "    \}else\{"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "      dot.style.background='#ddd';"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "    \}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  \});"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "\}"\cf4 \strokec4 ;\cb1 \
\
\
\
\cb3 html += \cf6 \strokec6 "function wakeDisplay() \{"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  return fetch('/brightness?value=1');"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "\}"\cf4 \strokec4 ;\cb1 \
\
\cb3 html += \cf6 \strokec6 "function updateTemp(change)\{"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  event.preventDefault();"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  const btn = event.target;"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  if(btn.disabled) return;"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  btn.disabled = true;"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  const targetDiv = document.querySelector('.target');"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  const currentTemp = parseFloat(targetDiv.innerText.match(/\\\\d+\\\\.?\\\\d*/)[0]);"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  const newTemp = Math.min(90, Math.max(50, currentTemp + change));"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  targetDiv.innerHTML = 'Target:<br>' + newTemp.toFixed(1) + '&deg;F';"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  wakeDisplay().then(() => \{"\cf4 \strokec4 ;\cf2 \strokec2   // Wake first\cf4 \cb1 \strokec4 \
\cb3 html += \cf6 \strokec6 "    return fetch('/target?temp='+change);"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  \}).then(()=>updateData())"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "    .finally(()=>setTimeout(()=>btn.disabled=false,250));"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "\}"\cf4 \strokec4 ;\cb1 \
\
\cb3 html += \cf6 \strokec6 "function toggleHeater()\{"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  wakeDisplay().then(() => \{"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "    return fetch('/toggle');"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  \}).then(()=>updateData());"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "\}"\cf4 \strokec4 ;\cb1 \
\
\cb3 html += \cf6 \strokec6 "const updateBrightness=debounce((val)=>\{fetch('/brightness?value='+val);\},250);"\cf4 \strokec4 ;\cb1 \
\
\cb3 html += \cf6 \strokec6 "function toggleFreezeGuard()\{"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  const checked=event.target.checked;"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  wakeDisplay().then(() => \{"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "    return fetch('/freezeguard?state='+(checked?'1':'0'));"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  \}).then(()=>updateData());"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "\}"\cf4 \strokec4 ;\cb1 \
\
\cb3 html += \cf6 \strokec6 "function updateData()\{const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),2000);fetch('/data',\{signal:controller.signal,timeout:1000\}).then(r=>r.json()).then(d=>\{clearTimeout(timeoutId);"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "document.getElementById('d').style.background='#0f0';"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "document.getElementById('status').textContent='Connected';"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "updateWifiDots(d.rssi);"\cf4 \strokec4 ;html += \cf6 \strokec6 "document.getElementById('h').style.background = d.heaterPinState ? '#FF3B30' : '#007AFF';"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "document.getElementById('heatStatus').textContent = d.heaterPinState ? 'Heat ON' : 'Heat OFF';"\cf4 \strokec4 ;\cb1 \
\
\cb3 html += \cf6 \strokec6 "document.querySelector('.temp').innerHTML = (d.currentTemp === 'TEMP SENSOR FAULT' ? d.currentTemp : d.currentTemp.toFixed(1)+'&deg;F');"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "document.querySelector('.humidity').innerHTML='Humidity: '+d.humidity.toFixed(1)+'%';"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "const t=document.querySelector('.target');"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "if(d.freezeGuardEnabled)\{"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  t.innerHTML='Target:<br>38.0&deg;F';"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  document.querySelectorAll('.btn').forEach(b=>\{b.disabled=true;b.style.opacity='0.5';\});"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "\} else \{"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  t.innerHTML='Target:<br>'+d.targetTemp.toFixed(1)+'&deg;F';"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  document.querySelectorAll('.btn').forEach(b=>\{b.disabled=false;b.style.opacity='1';\});"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "document.querySelector('input[onclick=\\"toggleFreezeGuard()\\"]').checked=d.freezeGuardEnabled;"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "document.querySelector('input[onclick=\\"toggleHeater()\\"]').checked=d.heaterEnabled;"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "document.querySelector('#heaterStatus').innerHTML='Heater '+(d.heaterEnabled?'ON':'OFF');"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "document.querySelector('#freezeStatus').innerHTML='Freeze Protection '+(d.freezeGuardEnabled?'ON':'OFF');"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "document.querySelector('#brightnessLabel').innerHTML = d.displaySleep ? 'SLEEPING' : 'Screen Brightness';"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "document.querySelector('input[type=\\"range\\"]').value = d.brightness;"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "\}).catch(()=>\{"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "document.getElementById('d').style.background='red';"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "Promise.any(["\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "fetch('http://192.168.1.1', \{mode: 'no-cors', timeout: 500\}),"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "fetch('http://192.168.0.1', \{mode: 'no-cors', timeout: 500\}),"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "fetch('http://10.0.0.1', \{mode: 'no-cors', timeout: 500\})"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "])"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".then(() => \{"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  document.getElementById('status').textContent='Device not found on network';"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "\})"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 ".catch(() => \{"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "  document.getElementById('status').textContent='Check phone WiFi connection';"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "\})"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "\});\}"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "setInterval(updateData,2000);"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "</script></head>"\cf4 \strokec4 ;\cb1 \
\
\
\cf2 \cb3 \strokec2 // Body with freeze-guard UI\cf4 \cb1 \strokec4 \
\cb3 html += \cf6 \strokec6 "<body>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<div class='card'>"\cf4 \strokec4 ;\cb1 \
\
\
\cb3 html += \cf6 \strokec6 "<div class='s' style='justify-content:space-between;border-bottom:1px solid #ddd;padding-bottom:8px;margin-bottom:12px'>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<div style='display:flex;align-items:center;gap:5px'>"\cf4 \strokec4 ;\cf2 \strokec2   // Left group\cf4 \cb1 \strokec4 \
\cb3 html += \cf6 \strokec6 "<div id='d' class='dot' style='background:red'></div>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<span id='status' style='font-size:12px'>Connecting...</span>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "</div>"\cf4 \strokec4 ;\cb1 \
\
\cb3 html += \cf6 \strokec6 "<div style='display:flex;align-items:center;gap:5px'>"\cf4 \strokec4 ;\cf2 \strokec2   // Center group wrapper\cf4 \cb1 \strokec4 \
\cb3 html += \cf6 \strokec6 "<div class='wifi-dots'>"\cf4 \strokec4 ;\cf2 \strokec2   // Dots container\cf4 \cb1 \strokec4 \
\cb3 html += \cf6 \strokec6 "<div class='wifi-dot' id='wifi1'></div>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<div class='wifi-dot' id='wifi2'></div>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<div class='wifi-dot' id='wifi3'></div>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<div class='wifi-dot' id='wifi4'></div>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<div class='wifi-dot' id='wifi5'></div>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "</div>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<span style='font-size:12px'>WiFi</span>"\cf4 \strokec4 ;\cf2 \strokec2   // Added WiFi text\cf4 \cb1 \strokec4 \
\cb3 html += \cf6 \strokec6 "</div>"\cf4 \strokec4 ;\cb1 \
\
\
\cb3 html += \cf6 \strokec6 "<div style='display:flex;align-items:center;gap:5px'>"\cf4 \strokec4 ;\cf2 \strokec2   // Right group\cf4 \cb1 \strokec4 \
\cb3 html += \cf6 \strokec6 "<div id='h' class='dot' style='background:blue'></div>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<span id='heatStatus' style='font-size:12px'>Heat OFF</span>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "</div>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "</div>"\cf4 \strokec4 ;\cb1 \
\
\
\cb3 html += \cf6 \strokec6 "<h1 style='font-size:28px;margin:0;text-align:center;'>RV Temperature Control</h1>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<div class='temp'>"\cf4 \strokec4  + \cf7 \strokec7 String\cf9 \strokec9 (\cf4 \strokec4 currentTemp,\cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4  + \cf6 \strokec6 "&deg;F</div>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<div class='humidity'>Humidity: "\cf4 \strokec4  + \cf7 \strokec7 String\cf9 \strokec9 (\cf4 \strokec4 humidity,\cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4  + \cf6 \strokec6 "%</div>"\cf4 \strokec4 ;\cb1 \
\
\cb3 html += \cf6 \strokec6 "<div class='controls' style='min-height:120px;'>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<button class='btn btn-down' onclick='updateTemp(-1)'>-</button>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<div class='target' style='min-width:100px;'>Target:<br>"\cf4 \strokec4  + \cf7 \strokec7 String\cf9 \strokec9 (\cf4 \strokec4 targetTemp,\cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4  + \cf6 \strokec6 "&deg;F</div>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<button class='btn btn-up' onclick='updateTemp(1)'>+</button>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "</div>"\cf4 \strokec4 ;\cb1 \
\
\cb3 html += \cf6 \strokec6 "<div class='toggle-container'>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<label class='toggle'>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<input type='checkbox' "\cf4 \strokec4  + \cf7 \strokec7 String\cf9 \strokec9 (\cf4 \strokec4 heaterEnabled?\cf6 \strokec6 "checked"\cf4 \strokec4 :\cf6 \strokec6 ""\cf9 \strokec9 )\cf4 \strokec4  + \cf6 \strokec6 " onclick='toggleHeater()'>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<span class='slider'></span>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "</label>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<div class='status' id='heaterStatus'>Heater "\cf4 \strokec4  + \cf7 \strokec7 String\cf9 \strokec9 (\cf4 \strokec4 heaterEnabled?\cf6 \strokec6 "ON"\cf4 \strokec4 :\cf6 \strokec6 "OFF"\cf9 \strokec9 )\cf4 \strokec4  + \cf6 \strokec6 "</div>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "</div>"\cf4 \strokec4 ;\cb1 \
\
\cb3 html += \cf6 \strokec6 "<div class='toggle-container'>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<div style='margin-bottom:8px;'>Freeze Guard (38deg)</div>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<label class='toggle'>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<input type='checkbox' "\cf4 \strokec4  + \cf7 \strokec7 String\cf9 \strokec9 (\cf4 \strokec4 freezeGuardEnabled?\cf6 \strokec6 "checked"\cf4 \strokec4 :\cf6 \strokec6 ""\cf9 \strokec9 )\cf4 \strokec4  + \cf6 \strokec6 " onclick='toggleFreezeGuard()'>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<span class='slider'></span>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "</label>"\cf4 \strokec4 ;\cb1 \
\
\cb3 html += \cf6 \strokec6 "<div class='status' id='freezeStatus' style='white-space:nowrap;'>Protection "\cf4 \strokec4  + \cf7 \strokec7 String\cf9 \strokec9 (\cf4 \strokec4 freezeGuardEnabled?\cf6 \strokec6 "ON"\cf4 \strokec4 :\cf6 \strokec6 "OFF"\cf9 \strokec9 )\cf4 \strokec4  + \cf6 \strokec6 "</div>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "</div>"\cf4 \strokec4 ;\cb1 \
\
\cf2 \cb3 \strokec2 // Find the brightness container section and replace with:\cf4 \cb1 \strokec4 \
\cb3 html += \cf6 \strokec6 "<div class='brightness-container'>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<label id='brightnessLabel'>Screen Brightness</label><br>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<input type='range' min='0' max='1' step='0.1' value='"\cf4 \strokec4  + \cf7 \strokec7 String\cf9 \strokec9 ((\cf8 \strokec8 float\cf9 \strokec9 )\cf4 \strokec4 displayBrightness/\cf6 \strokec6 255.0\cf4 \strokec4 ,\cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4  + \cf6 \strokec6 "' oninput='updateBrightness(this.value)' style='width:200px;'>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "</div>"\cf4 \strokec4 ;\cb1 \
\
\cb3 html += \cf6 \strokec6 "<div style='text-align:center;margin-top:32px;'>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "<button onclick='if(confirm(\\"Reset WiFi settings?\\"))\{window.location=\\"/reset\\";\}' style='background:#FF3B30;color:white;border:none;border-radius:8px;padding:12px 24px;font-size:16px;'>Reset WiFi Settings</button>"\cf4 \strokec4 ;\cb1 \
\cb3 html += \cf6 \strokec6 "</div>"\cf4 \strokec4 ;\cb1 \
\
\cb3 html += \cf6 \strokec6 "</div></body></html>"\cf4 \strokec4 ;\cb1 \
\
\cb3   \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 send\cf9 \strokec9 (\cf6 \strokec6 200\cf4 \strokec4 , \cf6 \strokec6 "text/html"\cf4 \strokec4 , html\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\
\
\cf2 \cb3 \strokec2 //part 11\cf4 \cb1 \strokec4 \
\
\
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleWiFiSetup\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 authenticate\cf9 \strokec9 (\cf4 \strokec4 www_username, www_password\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 return\cf4 \strokec4  \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 requestAuthentication\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 hasArg\cf9 \strokec9 (\cf6 \strokec6 "ssid"\cf9 \strokec9 )\cf4 \strokec4  && \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 hasArg\cf9 \strokec9 (\cf6 \strokec6 "password"\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     String newSSID = \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 arg\cf9 \strokec9 (\cf6 \strokec6 "ssid"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     String newPASS = \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 arg\cf9 \strokec9 (\cf6 \strokec6 "password"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 saveWiFiCredentials\cf9 \strokec9 (\cf4 \strokec4 newSSID, newPASS\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 send\cf9 \strokec9 (\cf6 \strokec6 200\cf4 \strokec4 , \cf6 \strokec6 "text/html"\cf4 \strokec4 , \cf6 \strokec6 "<html><body><h2>WiFi Settings Saved</h2><p>Device will now restart...</p></body></html>"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 delay\cf9 \strokec9 (\cf6 \strokec6 2000\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 ESP\cf4 \strokec4 .\cf7 \strokec7 restart\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     String html = \cf6 \strokec6 "<html><head>"\cf4 \strokec4 ;\cb1 \
\
\
\
\
\cb3 html += \cf6 \strokec6 "<meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no'>"\cf4 \strokec4 ;\cb1 \
\
\
\
\cb3     \cb1 \
\cb3     html += \cf6 \strokec6 "<style>body\{font-family:-apple-system,BlinkMacSystemFont,sans-serif;margin:0;padding:20px;background:#f0f2f5;\} .card\{background:white;border-radius:20px;padding:24px;margin:0 auto;max-width:500px;box-shadow:0 2px 12px rgba(0,0,0,0.1);\} input\{width:100%;padding:12px;margin:8px 0;border:1px solid #ddd;border-radius:8px;font-size:16px;\} button\{width:100%;padding:12px;background:#007AFF;color:white;border:none;border-radius:8px;font-size:16px;margin-top:16px;\} </style>"\cf4 \strokec4 ;\cb1 \
\cb3     html += \cf6 \strokec6 "</head><body><div class='card'>"\cf4 \strokec4 ;\cb1 \
\cb3     html += \cf6 \strokec6 "<h2>WiFi Setup</h2><form method='post'>"\cf4 \strokec4 ;\cb1 \
\cb3     html += \cf6 \strokec6 "<div>SSID:</div><input type='text' name='ssid'><br>"\cf4 \strokec4 ;\cb1 \
\cb3     html += \cf6 \strokec6 "<div>Password:</div><input type='password' name='password'><br>"\cf4 \strokec4 ;\cb1 \
\
\cb3     \cb1 \
\
\cb3         html += \cf6 \strokec6 "<button type='submit'>Save & Restart</button>"\cf4 \strokec4 ;\cb1 \
\cb3     html += \cf6 \strokec6 "</form>"\cf4 \strokec4 ;\cb1 \
\cb3     \cb1 \
\cb3     \cb1 \
\cb3    html += \cf6 \strokec6 "<a href='/control' class='link-btn direct-btn' style='margin-top:12px;display:block;text-align:center;padding:12px;background:#34C759;color:white;border-radius:8px;text-decoration:none;'>Direct Control Mode</a>"\cf4 \strokec4 ;\cb1 \
\cb3     html += \cf6 \strokec6 "</div></body></html>"\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 send\cf9 \strokec9 (\cf6 \strokec6 200\cf4 \strokec4 ,\cf6 \strokec6 "text/html"\cf4 \strokec4 ,html\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleTarget\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 authenticate\cf9 \strokec9 (\cf4 \strokec4 www_username, www_password\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 return\cf4 \strokec4  \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 requestAuthentication\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 hasArg\cf9 \strokec9 (\cf6 \strokec6 "temp"\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf8 \strokec8 float\cf4 \strokec4  change = \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 arg\cf9 \strokec9 (\cf6 \strokec6 "temp"\cf9 \strokec9 )\cf4 \strokec4 .\cf7 \strokec7 toFloat\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3     targetTemp += change;\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 targetTemp < \cf6 \strokec6 50\cf9 \strokec9 )\cf4 \strokec4  targetTemp = \cf6 \strokec6 50\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 targetTemp > \cf6 \strokec6 90\cf9 \strokec9 )\cf4 \strokec4  targetTemp = \cf6 \strokec6 90\cf4 \strokec4 ;\cb1 \
\cb3     showingStateChange = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3     stateChangeMessage = \cf7 \strokec7 String\cf9 \strokec9 (\cf4 \strokec4 targetTemp,\cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4  + \cf6 \strokec6 "F"\cf4 \strokec4 ;\cb1 \
\cb3     stateChangeTime = \cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 send\cf9 \strokec9 (\cf6 \strokec6 200\cf4 \strokec4 , \cf6 \strokec6 "text/plain"\cf4 \strokec4 , \cf6 \strokec6 "OK"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleToggle\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 authenticate\cf9 \strokec9 (\cf4 \strokec4 www_username, www_password\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 return\cf4 \strokec4  \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 requestAuthentication\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !freezeGuardEnabled\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf2 \strokec2   // Add this check\cf4 \cb1 \strokec4 \
\cb3     heaterEnabled = !heaterEnabled;\cb1 \
\cb3     \cf7 \strokec7 digitalWrite\cf9 \strokec9 (\cf4 \strokec4 HEATER_PIN, heaterEnabled ? HIGH : LOW\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     showingStateChange = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3     stateChangeMessage = \cf9 \strokec9 (\cf4 \strokec4 heaterEnabled ? \cf6 \strokec6 "HEAT ON"\cf4 \strokec4  : \cf6 \strokec6 "HEATOFF"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     stateChangeTime = \cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 send\cf9 \strokec9 (\cf6 \strokec6 200\cf4 \strokec4 , \cf6 \strokec6 "text/plain"\cf4 \strokec4 , \cf6 \strokec6 "OK"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\
\cf2 \cb3 \strokec2 //part 12\cf4 \cb1 \strokec4 \
\
\
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleBrightness\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 authenticate\cf9 \strokec9 (\cf4 \strokec4 www_username, www_password\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 return\cf4 \strokec4  \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 requestAuthentication\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 hasArg\cf9 \strokec9 (\cf6 \strokec6 "value"\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf8 \strokec8 float\cf4 \strokec4  val = \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 arg\cf9 \strokec9 (\cf6 \strokec6 "value"\cf9 \strokec9 )\cf4 \strokec4 .\cf7 \strokec7 toFloat\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 val == \cf6 \strokec6 0\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       displaySleepMode = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 clearDisplay\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 display\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3       displaySleepMode = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cb3       lastActivityTime = \cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3       displayBrightness = \cf9 \strokec9 (\cf8 \strokec8 uint8_t\cf9 \strokec9 )(\cf4 \strokec4 val * \cf6 \strokec6 255.0\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3       \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 dim\cf9 \strokec9 (\cf6 \strokec6 false\cf9 \strokec9 )\cf4 \strokec4 ;\cf2 \strokec2   // Force full brightness on wake\cf4 \cb1 \strokec4 \
\cb3       \cf7 \strokec7 updateDisplay\cf9 \strokec9 ()\cf4 \strokec4 ;\cf2 \strokec2      // Force display update\cf4 \cb1 \strokec4 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 send\cf9 \strokec9 (\cf6 \strokec6 200\cf4 \strokec4 , \cf6 \strokec6 "text/plain"\cf4 \strokec4 , \cf6 \strokec6 "OK"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleReset\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 authenticate\cf9 \strokec9 (\cf4 \strokec4 www_username, www_password\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 return\cf4 \strokec4  \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 requestAuthentication\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   String html = \cf6 \strokec6 "<html><head><meta name='viewport' content='width=device-width, initial-scale=1'>"\cf4 \strokec4 ;\cb1 \
\cb3   html += \cf6 \strokec6 "<style>body\{font-family:-apple-system,sans-serif;text-align:center;padding:20px;\} .info\{margin:20px;padding:15px;border:1px solid #ccc;border-radius:8px;\}</style>"\cf4 \strokec4 ;\cb1 \
\cb3   html += \cf6 \strokec6 "</head><body>"\cf4 \strokec4 ;\cb1 \
\cb3   html += \cf6 \strokec6 "<h2>Device is resetting...</h2>"\cf4 \strokec4 ;\cb1 \
\cb3   html += \cf6 \strokec6 "<p>Restarting in setup mode. Please connect using:</p>"\cf4 \strokec4 ;\cb1 \
\cb3   html += \cf6 \strokec6 "<div class='info'>"\cf4 \strokec4 ;\cb1 \
\cb3   html += \cf6 \strokec6 "<p><strong>WiFi Network:</strong> RV-THERMOSTAT<br>"\cf4 \strokec4 ;\cb1 \
\cb3   html += \cf6 \strokec6 "<strong>Network Password:</strong> RVthermostat</p>"\cf4 \strokec4 ;\cb1 \
\cb3   html += \cf6 \strokec6 "<p><strong>Web Interface:</strong> 192.168.4.1<br>"\cf4 \strokec4 ;\cb1 \
\cb3   html += \cf6 \strokec6 "<strong>Username:</strong> admin<br>"\cf4 \strokec4 ;\cb1 \
\cb3   html += \cf6 \strokec6 "<strong>Password:</strong> RVthermostat</p>"\cf4 \strokec4 ;\cb1 \
\cb3   html += \cf6 \strokec6 "</div></body></html>"\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 send\cf9 \strokec9 (\cf6 \strokec6 200\cf4 \strokec4 ,\cf6 \strokec6 "text/html"\cf4 \strokec4 ,html\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\
\cb3   \cf7 \strokec7 delay\cf9 \strokec9 (\cf6 \strokec6 2000\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 saveWiFiCredentials\cf9 \strokec9 (\cf6 \strokec6 ""\cf4 \strokec4 , \cf6 \strokec6 ""\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cf7 \strokec7 ESP\cf4 \strokec4 .\cf7 \strokec7 restart\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleData\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 authenticate\cf9 \strokec9 (\cf4 \strokec4 www_username, www_password\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 return\cf4 \strokec4  \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 requestAuthentication\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cb1 \
\cf2 \cb3 \strokec2   // Read actual heater pin state\cf4 \cb1 \strokec4 \
\cb3   \cf8 \strokec8 bool\cf4 \strokec4  actualHeaterState = \cf7 \strokec7 digitalRead\cf9 \strokec9 (\cf4 \strokec4 HEATER_PIN\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   \cb1 \
\cb3   String json = \cf6 \strokec6 "\{"\cf4 \strokec4 ;\cb1 \
\cb3   json += \cf6 \strokec6 "\\"currentTemp\\":"\cf4 \strokec4  + \cf9 \strokec9 (\cf7 \strokec7 isnan\cf9 \strokec9 (\cf4 \strokec4 currentTemp\cf9 \strokec9 )\cf4 \strokec4  ? \cf6 \strokec6 "\\"TEMP SENSOR FAULT\\""\cf4 \strokec4  : \cf7 \strokec7 String\cf9 \strokec9 (\cf4 \strokec4 currentTemp,\cf6 \strokec6 1\cf9 \strokec9 ))\cf4 \strokec4  + \cf6 \strokec6 ","\cf4 \strokec4 ;\cb1 \
\cb3   json += \cf6 \strokec6 "\\"humidity\\":"\cf4 \strokec4  + \cf7 \strokec7 String\cf9 \strokec9 (\cf4 \strokec4 humidity,\cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4  + \cf6 \strokec6 ","\cf4 \strokec4 ;\cb1 \
\cb3   json += \cf6 \strokec6 "\\"targetTemp\\":"\cf4 \strokec4  + \cf7 \strokec7 String\cf9 \strokec9 (\cf4 \strokec4 targetTemp,\cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4  + \cf6 \strokec6 ","\cf4 \strokec4 ;\cb1 \
\cb3   json += \cf6 \strokec6 "\\"heaterEnabled\\":"\cf4 \strokec4 ;\cb1 \
\cb3   json += \cf9 \strokec9 (\cf4 \strokec4 heaterEnabled ? \cf6 \strokec6 "true"\cf4 \strokec4  : \cf6 \strokec6 "false"\cf9 \strokec9 )\cf4 \strokec4 ;\cf2 \strokec2   // For toggle state\cf4 \cb1 \strokec4 \
\cb3   json += \cf6 \strokec6 ","\cf4 \strokec4 ;\cb1 \
\cb3   json += \cf6 \strokec6 "\\"heaterPinState\\":"\cf4 \strokec4 ;\cb1 \
\cb3   json += \cf9 \strokec9 (\cf4 \strokec4 actualHeaterState ? \cf6 \strokec6 "true"\cf4 \strokec4  : \cf6 \strokec6 "false"\cf9 \strokec9 )\cf4 \strokec4 ;\cf2 \strokec2   // For indicator dot\cf4 \cb1 \strokec4 \
\cb3   json += \cf6 \strokec6 ","\cf4 \strokec4 ;\cb1 \
\cb3   json += \cf6 \strokec6 "\\"freezeGuardEnabled\\":"\cf4 \strokec4 ;\cb1 \
\cb3   json += \cf9 \strokec9 (\cf4 \strokec4 freezeGuardEnabled ? \cf6 \strokec6 "true"\cf4 \strokec4  : \cf6 \strokec6 "false"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3   json += \cf6 \strokec6 ",\\"displaySleep\\":"\cf4 \strokec4 ;\cb1 \
\cb3   json += \cf9 \strokec9 (\cf4 \strokec4 displaySleepMode ? \cf6 \strokec6 "true"\cf4 \strokec4  : \cf6 \strokec6 "false"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3 json += \cf6 \strokec6 ",\\"brightness\\":"\cf4 \strokec4 ;\cb1 \
\cb3 json += \cf9 \strokec9 (\cf4 \strokec4 displaySleepMode ? \cf6 \strokec6 "0"\cf4 \strokec4  : \cf7 \strokec7 String\cf9 \strokec9 ((\cf8 \strokec8 float\cf9 \strokec9 )\cf4 \strokec4 displayBrightness/\cf6 \strokec6 255.0\cf4 \strokec4 ,\cf6 \strokec6 1\cf9 \strokec9 ))\cf4 \strokec4 ;\cb1 \
\cb3 json += \cf6 \strokec6 ",\\"rssi\\":"\cf4 \strokec4 ;\cb1 \
\cb3 json += \cf7 \strokec7 String\cf9 \strokec9 (\cf7 \strokec7 WiFi\cf4 \strokec4 .\cf7 \strokec7 RSSI\cf9 \strokec9 ())\cf4 \strokec4 ;\cf2 \strokec2   // Add RSSI value\cf4 \cb1 \strokec4 \
\cb3 json += \cf6 \strokec6 "\}"\cf4 \strokec4 ;\cb1 \
\
\cb3   \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 send\cf9 \strokec9 (\cf6 \strokec6 200\cf4 \strokec4 , \cf6 \strokec6 "application/json"\cf4 \strokec4 , json\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\
\
\
\
\
\
\
\
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleButtons\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf8 \strokec8 bool\cf4 \strokec4  currentUpState = \cf7 \strokec7 digitalRead\cf9 \strokec9 (\cf4 \strokec4 UP_BUTTON_PIN\cf9 \strokec9 )\cf4 \strokec4 ;\cf2 \strokec2     // GPIO13\cf4 \cb1 \strokec4 \
\cb3     \cf8 \strokec8 bool\cf4 \strokec4  currentDownState = \cf7 \strokec7 digitalRead\cf9 \strokec9 (\cf4 \strokec4 DOWN_BUTTON_PIN\cf9 \strokec9 )\cf4 \strokec4 ;\cf2 \strokec2  // GPIO14\cf4 \cb1 \strokec4 \
\cb3     \cf8 \strokec8 unsigned\cf4 \strokec4  \cf8 \strokec8 long\cf4 \strokec4  now = \cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3     \cb1 \
\cf2 \cb3 \strokec2     // Only update activity time when buttons are pressed\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 currentUpState == LOW || currentDownState == LOW\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3         lastActivityTime = now;\cb1 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cb3     \cf8 \strokec8 static\cf4 \strokec4  \cf8 \strokec8 bool\cf4 \strokec4  buttonsWereReleased = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 displaySleepMode\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2         // Only allow wake if buttons were previously released and grace period passed\cf4 \cb1 \strokec4 \
\cb3         \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 ((\cf4 \strokec4 now - sleepStartTime > \cf6 \strokec6 500\cf9 \strokec9 )\cf4 \strokec4  && \cb1 \
\cb3             buttonsWereReleased && \cb1 \
\cb3             \cf9 \strokec9 (\cf4 \strokec4 currentUpState == LOW || currentDownState == LOW\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3             displaySleepMode = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cb3             \cf7 \strokec7 display\cf4 \strokec4 .\cf7 \strokec7 dim\cf9 \strokec9 (\cf6 \strokec6 false\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3             showingStateChange = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3             stateChangeMessage = \cf6 \strokec6 "WAKE"\cf4 \strokec4 ;\cb1 \
\cb3             stateChangeTime = now;\cb1 \
\cb3             \cf7 \strokec7 delay\cf9 \strokec9 (\cf6 \strokec6 250\cf9 \strokec9 )\cf4 \strokec4 ;\cf2 \strokec2  // Debounce wake\cf4 \cb1 \strokec4 \
\cb3             \cf5 \strokec5 return\cf4 \strokec4 ;\cf2 \strokec2      // Exit to prevent unwanted actions\cf4 \cb1 \strokec4 \
\cb3         \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2         // Track if buttons are released while in sleep mode\cf4 \cb1 \strokec4 \
\cb3         buttonsWereReleased = \cf9 \strokec9 (\cf4 \strokec4 currentUpState == HIGH && currentDownState == HIGH\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3         \cf5 \strokec5 return\cf4 \strokec4 ;\cf2 \strokec2  // Don't process other button actions while sleeping\cf4 \cb1 \strokec4 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2     // Regular Button Handling (only if not in sleep mode)\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !displaySleepMode\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2         // UP Button Handler\cf4 \cb1 \strokec4 \
\cb3         \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 currentUpState != lastUpState\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3             \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 currentUpState == LOW\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf2 \strokec2   // Button just pressed\cf4 \cb1 \strokec4 \
\cb3                 upButtonStart = now;\cb1 \
\cb3                 longPressHandled = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cb3             \cf9 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf9 \strokec9 \{\cf2 \strokec2   // Button just released\cf4 \cb1 \strokec4 \
\cb3                 \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 now - upButtonStart < LONG_PRESS_MS\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2                     // Short press - increase temperature\cf4 \cb1 \strokec4 \
\cb3                     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !freezeGuardEnabled\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3                         targetTemp = \cf7 \strokec7 min\cf9 \strokec9 (\cf6 \strokec6 90.0\cf4 \strokec4 , targetTemp + \cf6 \strokec6 1.0\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3                         showingStateChange = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3                         stateChangeMessage = \cf7 \strokec7 String\cf9 \strokec9 (\cf4 \strokec4 targetTemp, \cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4  + \cf6 \strokec6 "F"\cf4 \strokec4 ;\cb1 \
\cb3                         stateChangeTime = now;\cb1 \
\cb3                     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3                 \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3             \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3             lastUpState = currentUpState;\cb1 \
\cb3         \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2         // UP long press check - Heat On/Off\cf4 \cb1 \strokec4 \
\cb3         \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 currentUpState == LOW && !longPressHandled && \cb1 \
\cb3             \cf9 \strokec9 (\cf4 \strokec4 now - upButtonStart >= LONG_PRESS_MS\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3             \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !freezeGuardEnabled\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf2 \strokec2   // Add this check\cf4 \cb1 \strokec4 \
\cb3                 heaterEnabled = !heaterEnabled;\cb1 \
\cb3                 \cf7 \strokec7 digitalWrite\cf9 \strokec9 (\cf4 \strokec4 HEATER_PIN, heaterEnabled ? HIGH : LOW\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3                 showingStateChange = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3                 stateChangeMessage = heaterEnabled ? \cf6 \strokec6 "HEAT ON"\cf4 \strokec4  : \cf6 \strokec6 "HEATOFF"\cf4 \strokec4 ;\cb1 \
\cb3                 stateChangeTime = now;\cb1 \
\cb3             \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3             longPressHandled = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3         \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2         // DOWN Button Handler\cf4 \cb1 \strokec4 \
\cb3         \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 currentDownState != lastDownState\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3             \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 currentDownState == LOW\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf2 \strokec2   // Button just pressed\cf4 \cb1 \strokec4 \
\cb3                 downButtonStart = now;\cb1 \
\cb3                 longPressHandled = \cf6 \strokec6 false\cf4 \strokec4 ;\cb1 \
\cb3             \cf9 \strokec9 \}\cf4 \strokec4  \cf5 \strokec5 else\cf4 \strokec4  \cf9 \strokec9 \{\cf2 \strokec2   // Button just released\cf4 \cb1 \strokec4 \
\cb3                 \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 now - downButtonStart < LONG_PRESS_MS\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2                     // Short press - decrease temperature\cf4 \cb1 \strokec4 \
\cb3                     \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !freezeGuardEnabled\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3                         targetTemp = \cf7 \strokec7 max\cf9 \strokec9 (\cf6 \strokec6 50.0\cf4 \strokec4 , targetTemp - \cf6 \strokec6 1.0\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3                         showingStateChange = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3                         stateChangeMessage = \cf7 \strokec7 String\cf9 \strokec9 (\cf4 \strokec4 targetTemp, \cf6 \strokec6 1\cf9 \strokec9 )\cf4 \strokec4  + \cf6 \strokec6 "F"\cf4 \strokec4 ;\cb1 \
\cb3                         stateChangeTime = now;\cb1 \
\cb3                     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3                 \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3             \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3             lastDownState = currentDownState;\cb1 \
\cb3         \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2         // DOWN long press check - Freeze Guard at 1s, WiFi Reset at 5s\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 // DOWN long press check - Freeze Guard at 1s, WiFi Reset at 5s\cf4 \cb1 \strokec4 \
\cb3         \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 currentDownState == LOW\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3             \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 now - downButtonStart >= WIFI_RESET_MS\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf2 \strokec2   // 5 second hold\cf4 \cb1 \strokec4 \
\cb3                 showingStateChange = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3                 stateChangeMessage = \cf6 \strokec6 "RESET"\cf4 \strokec4 ;\cb1 \
\cb3                 stateChangeTime = now;\cb1 \
\cb3                 \cf7 \strokec7 delay\cf9 \strokec9 (\cf6 \strokec6 1000\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3                 \cf7 \strokec7 saveWiFiCredentials\cf9 \strokec9 (\cf6 \strokec6 ""\cf4 \strokec4 , \cf6 \strokec6 ""\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3                 \cf7 \strokec7 ESP\cf4 \strokec4 .\cf7 \strokec7 restart\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3             \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3             \cf5 \strokec5 else\cf4 \strokec4  \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 now - downButtonStart >= LONG_PRESS_MS && !longPressHandled\cf9 \strokec9 )\cf4 \strokec4  \cf9 \strokec9 \{\cf2 \strokec2   // 1 second hold\cf4 \cb1 \strokec4 \
\cb3                 freezeGuardEnabled = !freezeGuardEnabled;\cb1 \
\cb3                 \cf7 \strokec7 saveFreezeGuardState\cf9 \strokec9 (\cf4 \strokec4 freezeGuardEnabled\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3                 showingStateChange = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3                 stateChangeMessage = freezeGuardEnabled ? \cf6 \strokec6 "GRD ON"\cf4 \strokec4  : \cf6 \strokec6 "GRD OFF"\cf4 \strokec4 ;\cb1 \
\cb3                 stateChangeTime = now;\cb1 \
\cb3                 longPressHandled = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3             \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3         \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3     \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\cf8 \cb3 \strokec8 void\cf4 \strokec4  \cf7 \strokec7 handleFreezeGuard\cf9 \strokec9 ()\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf4 \strokec4 !\cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 authenticate\cf9 \strokec9 (\cf4 \strokec4 www_username, www_password\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 return\cf4 \strokec4  \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 requestAuthentication\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  \cf9 \strokec9 (\cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 hasArg\cf9 \strokec9 (\cf6 \strokec6 "state"\cf9 \strokec9 ))\cf4 \strokec4  \cf9 \strokec9 \{\cf4 \cb1 \strokec4 \
\cb3     freezeGuardEnabled = \cf9 \strokec9 (\cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 arg\cf9 \strokec9 (\cf6 \strokec6 "state"\cf9 \strokec9 )\cf4 \strokec4  == \cf6 \strokec6 "1"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     \cf7 \strokec7 saveFreezeGuardState\cf9 \strokec9 (\cf4 \strokec4 freezeGuardEnabled\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     showingStateChange = \cf6 \strokec6 true\cf4 \strokec4 ;\cb1 \
\cb3     stateChangeMessage = \cf9 \strokec9 (\cf4 \strokec4 freezeGuardEnabled ? \cf6 \strokec6 "GRD ON"\cf4 \strokec4  : \cf6 \strokec6 "GRD OFF"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cb3     stateChangeTime = \cf7 \strokec7 millis\cf9 \strokec9 ()\cf4 \strokec4 ;\cb1 \
\cb3   \cf9 \strokec9 \}\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 server\cf4 \strokec4 .\cf7 \strokec7 send\cf9 \strokec9 (\cf6 \strokec6 200\cf4 \strokec4 , \cf6 \strokec6 "text/plain"\cf4 \strokec4 , \cf6 \strokec6 "OK"\cf9 \strokec9 )\cf4 \strokec4 ;\cb1 \
\cf9 \cb3 \strokec9 \}\cf4 \cb1 \strokec4 \
}